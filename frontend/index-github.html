<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvoiceExtractor - GitHub Pages</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1>InvoiceExtractor - GitHub Pages</h1>
            <nav>
                <button id="upload-btn" class="nav-btn active">Upload</button>
                <button id="demo-btn" class="nav-btn">Demo</button>
            </nav>
        </header>
        
        <main>
            <!-- Upload Section -->
            <section id="upload-section" class="section active">
                <h2>Extract Invoice/Receipt Data</h2>
                <p>Upload a PDF or image file to extract invoice/receipt data using browser-based OCR.</p>
                
                <div id="drop-area" class="drop-area">
                    <p>Drag & drop your file here or</p>
                    <button id="browse-btn" class="browse-btn">Browse Files</button>
                    <input type="file" id="file-input" accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
                    <p class="file-types">Supports: PDF, PNG, JPG (Max 5MB)</p>
                </div>
                
                <div id="progress-container" class="progress-container hidden">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="progress-text" class="progress-text">Processing...</p>
                </div>
                
                <div id="results-container" class="results-container hidden">
                    <h3>Extracted Data</h3>
                    <div id="extracted-results"></div>
                    <button id="export-json" class="btn">Export as JSON</button>
                    <button id="export-csv" class="btn">Export as CSV</button>
                </div>
            </section>
            
            <!-- Demo Section -->
            <section id="demo-section" class="section hidden">
                <h2>How It Works</h2>
                <div class="demo-info">
                    <p>This GitHub Pages version processes files directly in your browser using Tesseract.js OCR.</p>
                    <p><strong>No data is sent to any server - all processing happens locally on your device!</strong></p>
                    
                    <h3>Features:</h3>
                    <ul>
                        <li>PDF, PNG, JPG file support</li>
                        <li>Browser-based OCR processing</li>
                        <li>Automatic invoice/receipt data extraction</li>
                        <li>Export results as JSON/CSV</li>
                        <li>All processing happens locally</li>
                    </ul>
                    
                    <h3>Limitations:</h3>
                    <ul>
                        <li>Less accurate than server-side processing</li>
                        <li>Slower processing for large files</li>
                        <li>No persistent storage or history</li>
                        <li>No batch processing</li>
                    </ul>
                    
                    <h3>For Full Features:</h3>
                    <p>To use the complete InvoiceExtractor with server-side processing, batch uploads, and database storage, you'll need to run it locally:</p>
                    <pre><code>git clone https://github.com/your-username/InvoiceExtractor.git
cd InvoiceExtractor
./deploy.sh</code></pre>
                </div>
            </section>
        </main>
        
        <footer>
            <p>InvoiceExtractor - Extract invoice and receipt data using OCR</p>
        </footer>
    </div>
    
    <script>
        // DOM Elements
        const uploadSection = document.getElementById('upload-section');
        const demoSection = document.getElementById('demo-section');
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultsContainer = document.getElementById('results-container');
        const extractedResults = document.getElementById('extracted-results');
        const exportJsonBtn = document.getElementById('export-json');
        const exportCsvBtn = document.getElementById('export-csv');
        
        // Navigation
        document.getElementById('upload-btn').addEventListener('click', () => {
            uploadSection.classList.add('active');
            demoSection.classList.remove('active');
            document.getElementById('upload-btn').classList.add('active');
            document.getElementById('demo-btn').classList.remove('active');
        });
        
        document.getElementById('demo-btn').addEventListener('click', () => {
            uploadSection.classList.remove('active');
            demoSection.classList.add('active');
            document.getElementById('upload-btn').classList.remove('active');
            document.getElementById('demo-btn').classList.add('active');
        });
        
        // File handling
        browseBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', handleFileSelect);
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length) {
                handleFiles(e.dataTransfer.files);
            }
        });
        
        dropArea.addEventListener('click', () => fileInput.click());
        
        exportJsonBtn.addEventListener('click', () => exportResults('json'));
        exportCsvBtn.addEventListener('click', () => exportResults('csv'));
        
        // Functions
        function handleFileSelect(e) {
            if (e.target.files.length) {
                handleFiles(e.target.files);
            }
        }
        
        function handleFiles(files) {
            const file = files[0];
            if (!file) return;
            
            // Check file type
            const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please upload a PDF, PNG, or JPG file.');
                return;
            }
            
            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size exceeds 5MB limit.');
                return;
            }
            
            processFile(file);
        }
        
        async function processFile(file) {
            // Show progress
            uploadSection.classList.add('active');
            progressContainer.classList.remove('hidden');
            progressFill.style.width = '0%';
            progressText.textContent = 'Loading OCR engine...';
            
            try {
                // Load Tesseract.js worker
                const worker = await Tesseract.createWorker();
                await worker.load();
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                
                // Process file based on type
                if (file.type === 'application/pdf') {
                    progressText.textContent = 'Converting PDF to images...';
                    // For PDF, we would need pdf.js, but for simplicity, we'll show an error
                    throw new Error('PDF processing requires additional libraries. Please use PNG or JPG files for this demo.');
                } else {
                    // Process image file
                    progressText.textContent = 'Performing OCR...';
                    const { data: { text } } = await worker.recognize(file);
                    await worker.terminate();
                    
                    // Extract data from text
                    const extractedData = extractDataFromText(text);
                    
                    // Show results
                    displayResults(extractedData);
                }
            } catch (error) {
                console.error('Processing error:', error);
                progressText.textContent = `Error: ${error.message}`;
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 3000);
            }
        }
        
        function extractDataFromText(text) {
            // Simple regex-based extraction
            const data = {};
            
            // Extract vendor/merchant
            const vendorMatch = text.match(/(?:vendor|merchant|from)[:\s]*([^\n\r]+)/i);
            if (vendorMatch) {
                data.vendor = vendorMatch[1].trim();
            }
            
            // Extract date
            const dateMatch = text.match(/(?:date|invoice date)[:\s]*([0-9]{1,2}[\/\-][0-9]{1,2}[\/\-][0-9]{2,4})/i);
            if (dateMatch) {
                data.date = dateMatch[1].trim();
            }
            
            // Extract total
            const totalMatch = text.match(/(?:total|amount due)[:\s\$]*([0-9]+\.?[0-9]*)/i);
            if (totalMatch) {
                data.total = totalMatch[1].trim();
            }
            
            // Extract invoice number
            const invoiceMatch = text.match(/(?:invoice #|invoice number)[:\s]*([^\n\r]+)/i);
            if (invoiceMatch) {
                data.invoice_number = invoiceMatch[1].trim();
            }
            
            return data;
        }
        
        function displayResults(data) {
            extractedResults.innerHTML = '';
            
            if (Object.keys(data).length === 0) {
                extractedResults.innerHTML = '<p>No data extracted. Try a clearer image with more text.</p>';
            } else {
                for (const [key, value] of Object.entries(data)) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'result-item';
                    
                    const label = document.createElement('div');
                    label.className = 'result-label';
                    label.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    itemDiv.appendChild(label);
                    
                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'result-value';
                    valueDiv.textContent = value;
                    itemDiv.appendChild(valueDiv);
                    
                    extractedResults.appendChild(itemDiv);
                }
            }
            
            progressContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
        }
        
        function exportResults(format) {
            // Simple export functionality
            const data = {};
            const resultItems = document.querySelectorAll('.result-item');
            resultItems.forEach(item => {
                const label = item.querySelector('.result-label').textContent;
                const value = item.querySelector('.result-value').textContent;
                data[label] = value;
            });
            
            if (format === 'json') {
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'extracted_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (format === 'csv') {
                let csv = '';
                for (const [key, value] of Object.entries(data)) {
                    csv += `"${key}","${value}"\n`;
                }
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'extracted_data.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>